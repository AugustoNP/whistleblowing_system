<% content_for :header_title, "Admin Hub" %>
<% content_for :header_desc, "Gestão de Acessos Administrativos" %>

<%# --- SECTION: CREATE USER --- %>
<article class="card">
  <header class="card__header"><h2 class="card__title">Novo Usuário</h2></header>
  
  <%= form_with model: @new_user, url: admin_users_path, class: "report-form" do |f| %>
    
    <% if @new_user.errors.any? %>
      <div class="report-form__feedback">
        <ul class="error-list">
          <% @new_user.errors.each do |error| %>
            <li>
              <% if error.attribute == :email_address %>
                E-mail <%= error.message == "has already been taken" ? "já está em uso" : error.message %>
              <% elsif error.attribute == :username %>
                Login <%= error.message == "has already been taken" ? "já está em uso" : error.message %>
              <% elsif error.attribute == :password %>
                Senha <%= error.message.include?("too short") ? "é muito curta (mínimo 8 caracteres)" : error.message %>
              <% else %>
                <%= error.full_message %>
              <% end %>
            </li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="form-row">
      <div class="form-field"><%= f.label :username, "Login" %><%= f.text_field :username, class: "form-input", placeholder: "ex: j.silva" %></div>
      <div class="form-field"><%= f.label :email_address, "E-mail" %><%= f.email_field :email_address, class: "form-input", placeholder: "email@empresa.com" %></div>
      <div class="form-field">
        <%= f.label :role, "Nível" %>
        <%= f.select :role, User.roles.keys.reject { |r| r == 'visitor' }.map{|r| [r.humanize, r]}, {}, class: "form-select" %>
      </div>
    </div>
    <div class="form-row">
      <div class="form-field"><%= f.label :password, "Senha Inicial" %><%= f.password_field :password, class: "form-input" %></div>
      <div class="form-field"><%= f.label :password_confirmation, "Confirmar Senha" %><%= f.password_field :password_confirmation, class: "form-input" %></div>
    </div>
    <footer class="report-form__footer">
      <%= f.submit "Criar Conta", class: "button button--primary" %>
    </footer>
  <% end %>
</article>

<%# --- SECTION: USER LIST --- %>
<article class="card">
  <div class="card__table-wrapper">
    <table class="data-table">
      <thead>
        <tr>
          <th>Colaborador</th>
          <th>Permissão</th>
          <th class="text-right" style="padding-right: 2rem;">Ações</th>
        </tr>
      </thead>
      <tbody>
        <% @users.each do |user| %>
          <tr id="<%= dom_id user %>"> <%# ID helps Turbo stay in place %>
            <td>
              <div class="user-identity">
                <div class="user-profile__avatar user-profile__avatar--<%= user.role %>">
                  <%= user.username[0].upcase %>
                </div>
                <div class="user-profile__info">
                  <span class="user-profile__name" style="color:var(--text-main)"><%= user.username %></span>
                  <small style="color:var(--text-muted)"><%= user.email_address %></small>
                </div>
              </div>
            </td>
            <td>
              <% if user.admin? %>
                <span class="form-input" style="background: var(--bg-app); border-color: transparent; color: var(--primary); font-weight: bold; width: auto; display: inline-block;">
                  Admin
                </span>
              <% else %>
                <%= form_with model: [:admin, user], class: "inline-form" do |f| %>
                  <%= f.select :role, 
                      User.roles.keys.reject { |r| r == 'visitor' || r == 'admin' }.map { |r| [r.humanize, r] }, 
                      {}, 
                      { 
                        class: "form-select", 
                        style: "width: auto; min-width: 120px;", 
                        onchange: "this.form.requestSubmit()" 
                      } %>
                <% end %>
              <% end %>
            </td>
            <td class="text-right" style="padding-right: 2rem;">
              <div class="action-group" style="justify-content: flex-end; gap:0.5rem;">
                <button type="button" class="link-action" onclick="document.getElementById('pw-<%= user.id %>').showModal()">Senha</button>
                
                <% unless user == Current.user || user.admin? %>
                  <%= button_to "Excluir", 
                      admin_user_path(user), 
                      method: :delete, 
                      class: "link-delete", 
                      form: { data: { turbo_confirm: "Tem certeza que deseja excluir este usuário?" } } %>
                <% end %>
              </div>

              <dialog class="modal" id="pw-<%= user.id %>">
                <div class="modal__content">
                  <h3>Alterar Senha: <%= user.username %></h3>
                  <%= form_with model: [:admin, user], url: update_password_admin_user_path(user), method: :patch do |f| %>
                    <% if user.errors.any? %>
                      <div class="report-form__feedback">
                        <% user.errors.each do |error| %>
                           <p>Senha <%= error.message.include?("too short") ? "é muito curta (mínimo 8 caracteres)" : "inválida" %></p>
                        <% end %>
                      </div>
                    <% end %>
                    <div class="form-field"><%= f.password_field :password, class: "form-input", placeholder: "Nova senha (mín. 8 caracteres)" %></div>
                    <div class="form-field"><%= f.password_field :password_confirmation, class: "form-input", placeholder: "Confirme a nova senha" %></div>
                    <div class="card__footer">
                      <%= f.submit "Atualizar Senha", class: "button button--primary" %>
                      <button type="button" class="link-action" onclick="this.closest('dialog').close()">Cancelar</button>
                    </div>
                  <% end %>
                </div>
              </dialog>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</article>