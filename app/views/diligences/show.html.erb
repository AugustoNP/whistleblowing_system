<% content_for :header_title, "Visualização de Registro" %>
<% content_for :header_desc, "Protocolo: #{@diligence.protocolo}" %>

<%# 1. PRINT-ONLY HEADER (Hidden on web) %>
<div class="print-only-header">
  <div class="print-header-left">
    <strong>DUE DILIGENCE: <%= @diligence.razao_social %></strong>
    <br><small>Protocolo: <%= @diligence.protocolo %> | <%= @diligence.created_at.strftime("%d/%m/%Y") %></small>
  </div>
</div>

<article class="card">
  <%# Restore the Web UI Header %>
  <header class="card__header card__header--split no-print">
    <h2 class="card__title">Questionário de Due Diligence</h2>
    <span class="badge badge--protocol">Protocolo: <%= @diligence.protocolo %></span>
  </header>

  <section class="report-details">
    <% if @diligence.razao_social.present? %>
      
      <%# --- 1. CADASTRO --- %>
      <div class="report-details__section-title">1. Informações Cadastrais</div>
      <table class="pdf-table-fixed">
        <tr>
          <td width="35%"><label class="pdf-label">Razão Social</label><div class="pdf-value"><%= @diligence.razao_social %></div></td>
          <td width="30%"><label class="pdf-label">CNPJ</label><div class="pdf-value"><%= @diligence.cnpj %></div></td>
          <td width="35%"><label class="pdf-label">Nome Fantasia</label><div class="pdf-value"><%= @diligence.nome_fantasia.presence || "N/A" %></div></td>
        </tr>
        <tr>
          <td><label class="pdf-label">Website</label><div class="pdf-value"><%= @diligence.website.presence || "N/A" %></div></td>
          <td colspan="2"><label class="pdf-label">Endereço</label><div class="pdf-value"><%= @diligence.endereco %></div></td>
        </tr>
      </table>

      <%# --- 2. RESPONSÁVEL --- %>
      <div class="report-details__section-title">2. Responsável pelo Preenchimento</div>
      <table class="pdf-table-fixed">
        <tr>
          <td width="33%"><label class="pdf-label">Nome</label><div class="pdf-value"><%= @diligence.r_nome %></div></td>
          <td width="33%"><label class="pdf-label">Cargo</label><div class="pdf-value"><%= @diligence.r_cargo %></div></td>
          <td width="33%"><label class="pdf-label">E-mail</label><div class="pdf-value"><%= @diligence.r_email %></div></td>
        </tr>
      </table>

      <%# --- 3, 4, 5. TABLES --- %>
      <div class="pdf-tables-container">
        <%= render "shared/report_table", title: "3. Quadro Societário", collection: @diligence.socios, columns: ["Nome", "Cargo", "%"], fields: [:nome, :cargo, :percent] %>
        <%= render "shared/report_table", title: "4. Empresas Vinculadas", collection: @diligence.empresa_vinculadas, columns: ["Razão Social", "CNPJ", "Tipo"], fields: [:razao, :cnpj, :tipo] %>
        <%# Fixed fields for ParticipacaoSocio %>
        <%= render "shared/report_table", title: "5. Participação de Sócios em Outras Empresas", collection: @diligence.participacao_socios, columns: ["Sócio", "Empresa", "CNPJ"], fields: [:socio, :empresa, :cnpj] %>
      </div>

      <%# --- 6. THE 40+ QUESTIONS MATRIX (All Yes/No) --- %>
      <div class="report-details__section-title">6. Questionário de Compliance e Declarações</div>
      <table class="pdf-table-fixed matrix-table">
        <thead>
          <tr>
            <th width="40%">Pergunta</th><th width="10%">Resp.</th>
            <th width="40%">Pergunta</th><th width="10%">Resp.</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Possui Código de Conduta?</td><td class="text-center"><strong><%= @diligence.c_cod %></strong></td>
            <td>Possui Canal de Denúncias?</td><td class="text-center"><strong><%= @diligence.c_can %></strong></td>
          </tr>
          <tr>
            <td>Realiza Treinamentos de Ética?</td><td class="text-center"><strong><%= @diligence.c_trein %></strong></td>
            <td>Monitoramento de Terceiros?</td><td class="text-center"><strong><%= @diligence.c_mon %></strong></td>
          </tr>
          <tr>
            <td>Sócios ou Colaboradores são PEP?</td><td class="text-center"><strong><%= @diligence.peps.any? ? "SIM" : "NÃO" %></strong></td>
            <td>Parentesco com Agentes Públicos?</td><td class="text-center"><strong><%= @diligence.parentescos.any? ? "SIM" : "NÃO" %></strong></td>
          </tr>
          <tr>
            <td>Interação com Setor Público?</td><td class="text-center"><strong><%= @diligence.i_pub %></strong></td>
            <td>Identifica Beneficiário Final (UBO)?</td><td class="text-center"><strong><%= @diligence.ubo %></strong></td>
          </tr>
          <tr>
            <td>Possui Sanções ou Restrições?</td><td class="text-center"><strong><%= @diligence.restr %></strong></td>
            <td>Possui Licenças Ativas?</td><td class="text-center"><strong><%= @diligence.licencas.any? ? "SIM" : "NÃO" %></strong></td>
          </tr>
        </tbody>
      </table>

      <%# --- 7. ADDITIONAL TABLES (Licenças/PEPs) --- %>
      <% if @diligence.licencas.any? %>
        <%= render "shared/report_table", title: "7. Licenças e Autorizações", collection: @diligence.licencas, columns: ["Tipo", "Órgão", "Validade"], fields: [:tipo, :orgao, :validade] %>
      <% end %>

    <% end %>
  </section>

  <%# Restore Web Footer Actions %>
  <footer class="card__footer no-print">
    <div class="card__footer-actions">
    <%= link_to "Voltar", diligences_path, class: "button button--outline" %>
      <button onclick="window.print()" class="button button--primary">Imprimir Relato</button>
    </div>
  </footer>
</article>